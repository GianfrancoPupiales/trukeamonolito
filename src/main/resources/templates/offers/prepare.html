<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ofertar</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
<!-- Navbar -->
<th:block th:replace="~{navbar :: navbar}"></th:block>

<main class="container my-4">
    <!-- Feedback -->
    <th:block th:replace="~{alert :: alert}"></th:block>

    <div class="row">
        <div class="container mt-5">
            <div class="row">
                <!-- Producto objetivo (izquierda) -->
                <div class="col-md-6">
                    <div class="card border-0 rounded-3 mb-4" style="height: 100%;">
                        <div class="card-body p-4 d-flex" style="gap: 2rem;">
                            <div class="flex-grow-1 pe-3">
                                <h4 class="text-dark fw-bold mb-3" th:text="${productDetail.title}">Título del producto</h4>
                                <hr class="my-4">

                                <!-- Imagen -->
                                <div class="w-100 d-flex justify-content-center">
                                    <img th:if="${productDetail.photo != null and !#strings.isEmpty(productDetail.photo)}"
                                         th:src="@{/product-images/{file}(file=${productDetail.photo})}"
                                         alt="Product Photo"
                                         class="img-fluid"
                                         style="max-width: 250px; max-height: 280px; object-fit: contain; border-radius: 0.5rem;">
                                </div>

                                <hr class="my-4">
                                <h5 class="text-dark fw-bold mb-3">Datos del producto</h5>

                                <p class="card-text text-secondary small mb-4">
                                    <i class="fa-solid fa-align-left me-2"></i>
                                    <strong>Detalles:</strong>
                                    <span th:text="${productDetail.description}">Descripción</span>
                                </p>

                                <p class="card-text text-secondary small mb-4">
                                    <i class="fa-solid fa-layer-group me-2"></i>
                                    <strong>Condición:</strong>
                                    <span th:text="${productDetail.state}">Condición</span>
                                </p>

                                <p class="card-text text-secondary small mb-4">
                                    <i class="fa-solid fa-tags me-2"></i>
                                    <strong>Categoría:</strong>
                                    <span th:text="${productDetail.category}">Categoría</span>
                                </p>

                                <p class="card-text text-secondary small mb-4">
                                    <i class="fa-solid fa-calendar me-2"></i>
                                    <strong>Fecha Publicación:</strong>
                                    <span th:text="${#temporals.format(productDetail.datePublication, 'dd/MM/yyyy')}">01/01/2025</span>
                                </p>

                                <p class="card-text text-secondary small mb-4" th:if="${productDetail.preferences != null}">
                                    <i class="fa-solid fa-arrows-rotate me-2"></i>
                                    <strong>Preferencias de intercambio:</strong>
                                    <span th:each="pref, st : ${productDetail.preferences}">
                    <span th:text="${pref}">Pref</span><span th:if="${!st.last}">, </span>
                  </span>
                                </p>

                                <hr class="my-4">
                                <h5 class="text-dark fw-bold mb-3">Datos del propietario</h5>

                                <p class="card-text text-secondary small" sec:authorize="isAuthenticated()">
                                    <i class="fa-solid fa-user me-2"></i>
                                    <strong>Nombre:</strong>
                                    <span th:text="${productDetail.student.name}">Nombre</span>
                                </p>

                                <div class="alert alert-warning d-flex align-items-center small" role="alert"
                                     sec:authorize="isAnonymous()">
                                    <i class="fa-solid fa-user-lock me-2"></i>
                                    <span>Información del propietario no disponible hasta iniciar sesión.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Productos del usuario (derecha) -->
                <div class="col-md-6">
                    <h4 class="fw-bold">Selecciona qué ofrecer a cambio</h4>

                    <!-- Sin productos -->
                    <div class="alert alert-info mt-3" role="alert" th:if="${productsOfUser == null or #lists.isEmpty(productsOfUser)}">
                        <i class="fa-solid fa-triangle-exclamation me-2"></i>
                        No tienes productos que coincidan con las preferencias de intercambio de este producto.
                    </div>

                    <!-- Con productos -->
                    <form th:if="${productsOfUser != null and !#lists.isEmpty(productsOfUser)}"
                          th:action="@{/offers/propose}" method="post">
                        <input type="hidden" name="targetProductId" th:value="${productDetail.idProduct}"/>

                        <div class="form-group">
                            <div class="card border-1 rounded-3 mb-3 px-3 py-2"
                                 th:each="myProduct : ${productsOfUser}">
                                <div class="d-flex align-items-center justify-content-between">
                                    <!-- Checkbox + texto -->
                                    <div class="d-flex align-items-start" style="flex: 1;">
                                        <div class="form-check mt-1 me-3">
                                            <input class="form-check-input product-checkbox"
                                                   type="checkbox"
                                                   name="offeredProductIds"
                                                   th:value="${myProduct.idProduct}"
                                                   th:attr="data-category=${myProduct.category}">
                                        </div>
                                        <div>
                                            <label class="form-check-label fw-bold mb-1" th:text="${myProduct.title}">Título</label>
                                            <div class="text-secondary small mb-1">
                                                <i class="fa-solid fa-tags me-1"></i>
                                                <span th:text="${myProduct.category}">Categoría</span>
                                                (<span th:text="${myProduct.state}">Estado</span>)
                                            </div>
                                            <div class="text-muted small" th:text="${myProduct.description}">Descripción</div>
                                        </div>
                                    </div>

                                    <!-- Imagen -->
                                    <div style="width: 100px; height: 100px;">
                                        <img th:if="${myProduct.photo != null and !#strings.isEmpty(myProduct.photo)}"
                                             th:src="@{/product-images/{file}(file=${myProduct.photo})}"
                                             alt="Foto del producto"
                                             class="img-fluid rounded"
                                             style="object-fit: cover; width: 100%; height: 100%;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-outline-dark w-100 text-center mt-3" id="btnSubmitOffer">
                            <i class="fa-solid fa-paper-plane me-2"></i> Enviar oferta
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Modal para mensajes informativos y de error -->
<div class="modal modal-info" id="infoModal" tabindex="-1"
     aria-labelledby="infoModalLabel" aria-hidden="true"
     th:if="${message != null}">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body"
                 th:classappend="${messageType} == 'info' ? ' info' : ' error'">
                <i class="fas"
                   th:classappend="${messageType} == 'info' ? ' fa-info-circle text-info' : ' fa-exclamation-circle text-danger'"></i>
                <span th:text="${message}">Mensaje</span>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    // Mostrar modal informativo si hay mensaje
    const message = /*[[${message}]]*/ null;
    if (message) {
        const infoModalElement = document.getElementById("infoModal");
        if (infoModalElement) {
            const infoModal = new bootstrap.Modal(infoModalElement, {
                backdrop: false,
                keyboard: false
            });
            infoModal.show();
            setTimeout(() => infoModal.hide(), 1000);
        }
    }

    // Cierra automáticamente la alerta después de 2 segundos
    setTimeout(() => {
        const alert = document.querySelector('.alert-dismissible');
        if (alert) {
            const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
            bsAlert.close();
        }
    }, 2000);

    // Validación del formulario: al menos un producto debe estar seleccionado
    const form = document.querySelector('form[action*="/offers/propose"]');
    if (form) {
        form.addEventListener('submit', function(e) {
            const checkboxes = document.querySelectorAll('input[name="offeredProductIds"]:checked');
            if (checkboxes.length === 0) {
                e.preventDefault();
                alert('Por favor selecciona al menos un producto para ofrecer.');
                return false;
            }
        });
    }
</script>
</body>
</html>