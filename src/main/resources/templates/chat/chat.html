<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/springsecurity">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Trukea</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .chat-container {
            display: flex;
            height: calc(100vh - 60px);
            max-width: 100%;
            margin: 0;
            background: white;
            box-shadow: none;
            overflow: hidden;
        }

        /* Sidebar de conversaciones */
        .conversations-sidebar {
            width: 350px;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            background: white;
        }

        .sidebar-header h5 {
            margin: 0;
            color: #212529;
            font-weight: 600;
        }

        .conversations-list {
            overflow-y: auto;
            flex: 1;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .conversation-item:hover {
            background-color: #f8f9fa;
        }

        .conversation-item.active {
            background-color: #e7f3ff;
            border-left: 3px solid #0d6efd;
        }

        .conversation-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
            flex-shrink: 0;
            border: 2px solid #dee2e6;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            font-weight: 600;
            color: #212529;
            margin-bottom: 3px;
            font-size: 15px;
        }

        .conversation-last-message {
            color: #6c757d;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .conversation-time {
            font-size: 11px;
            color: #6c757d;
        }

        .unread-badge {
            background-color: #0d6efd;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        /* √Årea de chat */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-header {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
        }

        .chat-header-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
            border: 2px solid #dee2e6;
        }

        .chat-header-info h6 {
            margin: 0;
            color: #212529;
            font-size: 16px;
            font-weight: 600;
        }

        .typing-indicator {
            color: #0d6efd;
            font-size: 12px;
            font-style: italic;
        }

        /* Panel de ofertas relacionadas */
        .offers-context-panel {
            background: #f0f7ff;
            border-bottom: 1px solid #d0e5ff;
        }

        .offers-context-header {
            padding: 10px 20px;
            background: #e3f2fd;
            border-bottom: 1px solid #bbdefb;
            font-weight: 600;
            font-size: 13px;
            color: #1976d2;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .offers-context-header:hover {
            background: #d1e9fc;
        }

        .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 12px;
        }

        .toggle-icon.rotated {
            transform: rotate(180deg);
        }

        .offers-context-list {
            padding: 10px 20px;
            max-height: 200px;
            overflow-y: auto;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .offers-context-list.collapsed {
            max-height: 0;
            padding: 0 20px;
            overflow: hidden;
        }

        .offer-context-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #d0e5ff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .offer-products-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .offer-side {
            flex: 1;
        }

        .offer-label {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .products-list {
            font-size: 13px;
            color: #212529;
            line-height: 1.4;
        }

        .product-name {
            font-weight: 500;
        }

        .exchange-icon {
            color: #0d6efd;
            font-size: 18px;
            flex-shrink: 0;
        }

        .offer-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .offer-status-badge.status-ACCEPTED {
            background: #d4edda;
            color: #155724;
        }

        .offer-status-badge.status-COMPLETED {
            background: #fff3cd;
            color: #856404;
        }

        .offer-status-badge.status-PENDING {
            background: #cfe2ff;
            color: #084298;
        }

        .offer-status-badge i {
            font-size: 12px;
        }

        /* Mensajes */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }

        .message {
            display: flex;
            margin-bottom: 12px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message.received {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 65%;
            padding: 10px 14px;
            border-radius: 12px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .message.sent .message-bubble {
            background-color: #0d6efd;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.received .message-bubble {
            background-color: white;
            border: 1px solid #e0e0e0;
            color: #212529;
            border-bottom-left-radius: 4px;
        }

        .message-content {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 4px;
        }

        .message-time {
            font-size: 10px;
            text-align: right;
            margin-top: 4px;
            opacity: 0.7;
        }

        .message.sent .message-time {
            color: rgba(255,255,255,0.9);
        }

        .message.received .message-time {
            color: #6c757d;
        }

        /* Input de mensajes */
        .message-input-container {
            background: white;
            padding: 15px 20px;
            border-top: 1px solid #dee2e6;
        }

        .message-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            border-radius: 25px;
            padding: 5px 10px;
            border: 1px solid #dee2e6;
        }

        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 8px 15px;
            color: #212529;
            font-size: 14px;
        }

        .message-input:focus {
            outline: none;
        }

        .message-input::placeholder {
            color: #6c757d;
        }

        .send-button {
            background-color: #0d6efd;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }

        .send-button:hover {
            background-color: #0b5ed7;
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Estado vac√≠o */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 60px;
            margin-bottom: 15px;
            color: #dee2e6;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        @media (max-width: 768px) {
            .chat-container {
                margin: 0;
                border-radius: 0;
            }

            .conversations-sidebar {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div th:replace="~{navbar :: navbar}"></div>

<div class="chat-container">
    <!-- Sidebar de conversaciones -->
    <div class="conversations-sidebar">
        <div class="sidebar-header">
            <h5><i class="fas fa-comments me-2"></i>Conversaciones</h5>
        </div>
        <div class="conversations-list">
            <div th:if="${conversations.isEmpty()}" class="p-4 text-center text-muted">
                <p class="mb-0">No tienes conversaciones activas</p>
                <small>Las conversaciones se crean cuando aceptas una oferta</small>
            </div>
            <div th:each="conv : ${conversations}"
                 class="conversation-item"
                 th:classappend="${conversation != null && conv.conversationId == conversation.idConversation} ? 'active' : ''"
                 th:onclick="'window.location.href=\'/chat/conversation/' + ${conv.conversationId} + '\''">
                <img th:if="${conv.otherStudentPhoto != null && !#strings.isEmpty(conv.otherStudentPhoto)}"
                     th:src="@{/student-images/{file}(file=${conv.otherStudentPhoto})}"
                     class="conversation-avatar"
                     alt="Avatar">
                <img th:if="${conv.otherStudentPhoto == null || #strings.isEmpty(conv.otherStudentPhoto)}"
                     src="https://ui-avatars.com/api/?name=User&background=0D6EFD&color=fff"
                     class="conversation-avatar"
                     alt="Avatar">
                <div class="conversation-info">
                    <div class="conversation-name" th:text="${conv.otherStudentName}">Nombre</div>
                    <div class="conversation-last-message" th:text="${conv.lastMessage}">√öltimo mensaje</div>
                </div>
                <div class="conversation-meta">
                    <div class="conversation-time"
                         th:text="${#temporals.format(conv.lastMessageAt, 'HH:mm')}">12:30</div>
                    <span th:if="${conv.unreadCount > 0}"
                          class="unread-badge"
                          th:text="${conv.unreadCount}">3</span>
                </div>
            </div>
        </div>
    </div>

    <!-- √Årea de chat -->
    <div class="chat-area">
        <div th:if="${conversation == null}" class="empty-state">
            <i class="fas fa-comments"></i>
            <h5>Selecciona una conversaci√≥n</h5>
            <p class="small">Elige una conversaci√≥n de la lista para comenzar a chatear</p>
        </div>

        <div th:if="${conversation != null}" style="display: flex; flex-direction: column; height: 100%;">
            <!-- Header del chat -->
            <div class="chat-header">
                <img th:if="${otherStudent.photo != null && !#strings.isEmpty(otherStudent.photo)}"
                     th:src="@{/student-images/{file}(file=${otherStudent.photo})}"
                     class="chat-header-avatar"
                     alt="Avatar">
                <img th:if="${otherStudent.photo == null || #strings.isEmpty(otherStudent.photo)}"
                     src="https://ui-avatars.com/api/?name=User&background=0D6EFD&color=fff"
                     class="chat-header-avatar"
                     alt="Avatar">
                <div class="chat-header-info">
                    <h6 th:text="${otherStudent.name}">Nombre del contacto</h6>
                    <div class="typing-indicator" id="typingIndicator" style="display: none;">
                        escribiendo...
                    </div>
                </div>
            </div>

            <!-- Ofertas relacionadas -->
            <div th:if="${conversation.offers != null && !conversation.offers.isEmpty()}"
                 class="offers-context-panel">
                <div class="offers-context-header" onclick="toggleOffersPanel()" style="cursor: pointer;">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Ofertas relacionadas (<span th:text="${conversation.offers.size()}">0</span>)</span>
                    <i class="fas fa-chevron-down toggle-icon rotated" id="offersToggleIcon" style="margin-left: auto;"></i>
                </div>
                <div class="offers-context-list collapsed" id="offersContextList">
                    <div th:each="offer : ${conversation.offers}" class="offer-context-item">
                        <div class="offer-products-row">
                            <!-- Productos ofrecidos -->
                            <div class="offer-side">
                                <div class="offer-label">Ofrecidos</div>
                                <div class="products-list">
                                    <span th:each="product, iterStat : ${offer.offeredProducts}" class="product-name">
                                        <span th:text="${product.title}">Producto</span><span th:if="${!iterStat.last}">, </span>
                                    </span>
                                </div>
                            </div>

                            <div class="exchange-icon">
                                <i class="fas fa-exchange-alt"></i>
                            </div>

                            <!-- Producto solicitado -->
                            <div class="offer-side">
                                <div class="offer-label">Solicitado</div>
                                <div class="products-list">
                                    <span class="product-name" th:text="${offer.productToOffer.title}">Producto</span>
                                </div>
                            </div>
                        </div>
                        <div class="offer-status-badge" th:classappend="${'status-' + offer.status}">
                            <i class="fas" th:classappend="${offer.status == T(com.apirip.trukeamonolito.offer.domain.OfferStatus).ACCEPTED ? 'fa-check-circle' :
                                                            offer.status == T(com.apirip.trukeamonolito.offer.domain.OfferStatus).COMPLETED ? 'fa-star' : 'fa-times-circle'}"></i>
                            <span th:text="${offer.status}">ACCEPTED</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mensajes -->
            <div class="messages-container" id="messagesContainer">
                <div th:each="msg : ${messages}"
                     th:classappend="${msg.sender.idStudent == currentStudent.idStudent} ? 'sent' : 'received'"
                     class="message">
                    <div class="message-bubble">
                        <div class="message-content" th:text="${msg.content}">Contenido del mensaje</div>
                        <div class="message-time"
                             th:text="${#temporals.format(msg.sentAt, 'HH:mm')}">12:30</div>
                    </div>
                </div>
            </div>

            <!-- Input de mensaje -->
            <div class="message-input-container">
                <div class="message-input-wrapper">
                    <input type="text"
                           class="message-input"
                           id="messageInput"
                           placeholder="Escribe un mensaje..."
                           autocomplete="off">
                    <button class="send-button" id="sendButton" title="Enviar mensaje">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    const currentStudentId = /*[[${currentStudent.idStudent}]]*/ 0;
    const currentStudentName = /*[[${currentStudent.name}]]*/ 'Usuario';
    const currentConversationId = /*[[${conversation?.idConversation}]]*/ null;

    let stompClient = null;
    let typingTimeout = null;

    // Toggle para mostrar/ocultar ofertas relacionadas
    function toggleOffersPanel() {
        const offersList = document.getElementById('offersContextList');
        const toggleIcon = document.getElementById('offersToggleIcon');

        if (offersList && toggleIcon) {
            offersList.classList.toggle('collapsed');
            toggleIcon.classList.toggle('rotated');
        }
    }

    // Conectar a WebSocket
    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        // Habilitar logs de debug solo en desarrollo
        stompClient.debug = function(str) {
            console.log('[STOMP] ' + str);
        };

        stompClient.connect({}, function(frame) {
            console.log('‚úÖ Conectado al WebSocket exitosamente');
            console.log('Frame:', frame);

            if (currentConversationId) {
                console.log('üì° Suscribi√©ndose a conversaci√≥n ID:', currentConversationId);

                // Suscribirse a los mensajes de esta conversaci√≥n
                // Formato para RabbitMQ STOMP: /topic/conversation.{id}
                const topicDestination = '/topic/conversation.' + currentConversationId;
                console.log('üì° Destino STOMP:', topicDestination);

                const subscription = stompClient.subscribe(topicDestination, function(message) {
                    console.log('üì® Mensaje recibido v√≠a WebSocket:', message.body);
                    try {
                        const msg = JSON.parse(message.body);
                        console.log('üì© Mensaje parseado:', msg);
                        displayMessage(msg);
                    } catch (e) {
                        console.error('‚ùå Error al parsear mensaje:', e);
                    }
                });
                console.log('‚úÖ Suscripci√≥n exitosa a', topicDestination);

                // Nota: Typing indicator deshabilitado con RabbitMQ STOMP
                // RabbitMQ requiere formato diferente para /user destinations
            }
        }, function(error) {
            console.error('‚ùå Error de conexi√≥n WebSocket:', error);
            console.log('üîÑ Reintentando conexi√≥n en 5 segundos...');
            setTimeout(connect, 5000);
        });

        // Detectar desconexi√≥n
        socket.onclose = function() {
            console.warn('‚ö†Ô∏è Conexi√≥n WebSocket cerrada. Reconectando...');
            setTimeout(connect, 3000);
        };
    }

    // Enviar mensaje
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const content = input.value.trim();

        if (!content) {
            console.log('‚ö†Ô∏è Mensaje vac√≠o, no se env√≠a');
            return;
        }

        if (!currentConversationId) {
            console.error('‚ùå No hay conversaci√≥n activa');
            return;
        }

        if (!stompClient || !stompClient.connected) {
            console.error('‚ùå WebSocket no conectado');
            alert('No est√°s conectado al chat. Recargando...');
            location.reload();
            return;
        }

        const message = {
            conversationId: currentConversationId,
            senderId: currentStudentId,
            content: content,
            type: 'CHAT'
        };

        console.log('üì§ Enviando mensaje:', message);
        stompClient.send('/app/chat/' + currentConversationId, {}, JSON.stringify(message));
        console.log('‚úÖ Mensaje enviado al servidor');
        input.value = '';
    }

    // Mostrar mensaje en la UI
    function displayMessage(msg) {
        console.log('üé® Mostrando mensaje en UI:', msg);

        const container = document.getElementById('messagesContainer');
        if (!container) {
            console.error('‚ùå Contenedor de mensajes no encontrado');
            return;
        }

        const isSent = msg.senderId === currentStudentId;
        console.log('üë§ Mensaje es de:', isSent ? 'm√≠ (enviado)' : 'otro usuario (recibido)');

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ' + (isSent ? 'sent' : 'received');

        // Usar la fecha del mensaje si est√° disponible, sino usar la hora actual
        let time;
        if (msg.sentAt) {
            const sentDate = new Date(msg.sentAt);
            time = sentDate.getHours().toString().padStart(2, '0') + ':' +
                   sentDate.getMinutes().toString().padStart(2, '0');
        } else {
            const now = new Date();
            time = now.getHours().toString().padStart(2, '0') + ':' +
                   now.getMinutes().toString().padStart(2, '0');
        }

        messageDiv.innerHTML = `
            <div class="message-bubble">
                <div class="message-content">${escapeHtml(msg.content)}</div>
                <div class="message-time">${time}</div>
            </div>
        `;

        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
        console.log('‚úÖ Mensaje agregado a la UI y scroll actualizado');
    }

    // Indicador de "escribiendo" - DESHABILITADO con RabbitMQ
    function sendTypingIndicator() {
        // Deshabilitado: RabbitMQ STOMP requiere formato diferente para /user destinations
        // Para habilitar, usar /exchange/amq.topic/typing.{conversationId}
    }

    function showTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) {
            indicator.style.display = 'block';
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }
    }

    // Escapar HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const messagesContainer = document.getElementById('messagesContainer');

        if (currentConversationId) {
            connect();

            // Scroll al final de los mensajes
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sendMessage();
                    }
                });

                messageInput.addEventListener('input', function() {
                    sendTypingIndicator();
                });
            }

            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            }
        }
    });

    // Desconectar al salir
    window.addEventListener('beforeunload', function() {
        if (stompClient && stompClient.connected) {
            stompClient.disconnect();
        }
    });
    /*]]>*/
</script>
</body>
</html>
