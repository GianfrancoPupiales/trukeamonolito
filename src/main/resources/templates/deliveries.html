<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Entregas Pendientes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        .rating-stars {
            direction: rtl;
            unicode-bidi: bidi-override;
            display: inline-flex;
            flex-direction: row-reverse;
            justify-content: center;
        }
        .rating-stars input {
            display: none;
        }
        .rating-stars label {
            color: #ddd;
            font-size: 2rem;
            cursor: pointer;
            transition: color 0.2s;
            margin: 0 2px;
        }
        .rating-stars label:hover,
        .rating-stars label:hover ~ label,
        .rating-stars input:checked ~ label {
            color: #ffc107;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<th:block th:replace="~{navbar :: navbar}"></th:block>

<main class="container my-4">
    <h1 class="mb-4 text-center">Entregas Pendientes</h1>

    <!-- Feedback -->
    <th:block th:replace="~{alert :: alert}"></th:block>

    <!-- Sin entregas pendientes -->
    <div th:if="${pendingDeliveries == null or #lists.isEmpty(pendingDeliveries)}"
         class="alert alert-info text-center">
        No tienes entregas pendientes por confirmar.
    </div>

    <!-- Con entregas pendientes -->
    <div class="row row-cols-1 g-4"
         th:if="${pendingDeliveries != null and !#lists.isEmpty(pendingDeliveries)}">
        <div class="col" th:each="offer,iter : ${pendingDeliveries}"
             th:with="
           yoSoyOfertante=${offer.studentWhoOffered.idStudent} == ${currentStudentId},
           idOtro=${yoSoyOfertante} ? ${offer.productToOffer.student.idStudent} : ${offer.studentWhoOffered.idStudent},
           nombreOtro=${yoSoyOfertante} ? ${offer.productToOffer.student.name} : ${offer.studentWhoOffered.name},
           yoConfirme=${yoSoyOfertante} ? ${offer.confirmedByOfferer} : ${offer.confirmedByOwner},
           otroConfirmo=${yoSoyOfertante} ? ${offer.confirmedByOwner} : ${offer.confirmedByOfferer}
         ">
            <div class="card shadow-sm border-0 rounded-3">
                <div class="card-body">
                    <h5 class="fw-bold text-dark mb-3">
                        <i class="fa-solid fa-truck me-2"></i>
                        Trueque con:
                        <a class="text-decoration-none"
                           th:href="@{/profile/public/{id}(id=${idOtro})}"
                           th:text="${nombreOtro}">Nombre</a>
                    </h5>

                    <!-- Estado de confirmación -->
                    <div class="alert mb-3"
                         th:classappend="${yoConfirme} ? 'alert-success' : 'alert-warning'">
                        <i class="fa-solid me-2"
                           th:classappend="${yoConfirme} ? 'fa-check-circle' : 'fa-clock'"></i>
                        <strong th:if="${yoConfirme}">Tú ya confirmaste la entrega y calificaste al otro usuario.</strong>
                        <strong th:if="${!yoConfirme}">Pendiente: Debes confirmar que recibiste los productos y calificar al usuario.</strong>
                    </div>

                    <div class="alert alert-info mb-3" th:if="${yoConfirme && !otroConfirmo}">
                        <i class="fa-solid fa-hourglass-half me-2"></i>
                        <strong>Esperando que <span th:text="${nombreOtro}">el otro usuario</span> confirme la entrega.</strong>
                    </div>

                    <div class="alert alert-success mb-3" th:if="${otroConfirmo && !yoConfirme}">
                        <i class="fa-solid fa-check-circle me-2"></i>
                        <span th:text="${nombreOtro}">Otro</span> ya confirmó la entrega y te calificó.
                    </div>

                    <div class="row">
                        <!-- Productos que entregaste -->
                        <div class="col-md-5">
                            <h6 class="fw-bold text-secondary mb-3">Productos que entregaste</h6>

                            <!-- Si ofreciste: lista -->
                            <div th:if="${yoSoyOfertante}">
                                <div class="card border-1 rounded-3 mb-3 px-3 py-2" th:each="p : ${offer.offeredProducts}">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="me-3" style="flex:1">
                                            <label class="fw-bold mb-1" th:text="${p.title}">Título</label>
                                            <div class="text-secondary small mb-1">
                                                <i class="fa-solid fa-tags me-1"></i>
                                                <span th:text="${p.category}">Categoría</span>
                                                (<span th:text="${p.state}">Estado</span>)
                                            </div>
                                            <div class="text-muted small" th:text="${p.description}">Descripción</div>
                                        </div>
                                        <div style="width: 100px; height: 100px;">
                                            <img th:if="${p.photo != null and !#strings.isEmpty(p.photo)}"
                                                 th:src="@{/product-images/{file}(file=${p.photo})}"
                                                 alt="Foto del producto"
                                                 class="img-fluid rounded"
                                                 style="object-fit: cover; width: 100%; height: 100%;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Si no ofreciste: único -->
                            <div th:if="${!yoSoyOfertante}">
                                <div class="card border-1 rounded-3 mb-3 px-3 py-2">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="me-3" style="flex:1">
                                            <label class="fw-bold mb-1" th:text="${offer.productToOffer.title}">Título</label>
                                            <div class="text-secondary small mb-1">
                                                <i class="fa-solid fa-tags me-1"></i>
                                                <span th:text="${offer.productToOffer.category}">Categoría</span>
                                                (<span th:text="${offer.productToOffer.state}">Estado</span>)
                                            </div>
                                            <div class="text-muted small" th:text="${offer.productToOffer.description}">Descripción</div>
                                        </div>
                                        <div style="width: 100px; height: 100px;">
                                            <img th:if="${offer.productToOffer.photo != null and !#strings.isEmpty(offer.productToOffer.photo)}"
                                                 th:src="@{/product-images/{file}(file=${offer.productToOffer.photo})}"
                                                 alt="Foto del producto"
                                                 class="img-fluid rounded"
                                                 style="object-fit: cover; width: 100%; height: 100%;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Productos que recibiste -->
                        <div class="col-md-5">
                            <h6 class="fw-bold text-secondary mb-3">Productos que recibiste</h6>

                            <!-- Si ofreciste: único -->
                            <div th:if="${yoSoyOfertante}">
                                <div class="card border-1 rounded-3 mb-3 px-3 py-2">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="me-3" style="flex:1">
                                            <label class="fw-bold mb-1" th:text="${offer.productToOffer.title}">Título</label>
                                            <div class="text-secondary small mb-1">
                                                <i class="fa-solid fa-tags me-1"></i>
                                                <span th:text="${offer.productToOffer.category}">Categoría</span>
                                                (<span th:text="${offer.productToOffer.state}">Estado</span>)
                                            </div>
                                            <div class="text-muted small" th:text="${offer.productToOffer.description}">Descripción</div>
                                        </div>
                                        <div style="width: 100px; height: 100px;">
                                            <img th:if="${offer.productToOffer.photo != null and !#strings.isEmpty(offer.productToOffer.photo)}"
                                                 th:src="@{/product-images/{file}(file=${offer.productToOffer.photo})}"
                                                 alt="Foto del producto"
                                                 class="img-fluid rounded"
                                                 style="object-fit: cover; width: 100%; height: 100%;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Si no ofreciste: lista -->
                            <div th:if="${!yoSoyOfertante}">
                                <div class="card border-1 rounded-3 mb-3 px-3 py-2" th:each="p : ${offer.offeredProducts}">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="me-3" style="flex:1">
                                            <label class="fw-bold mb-1" th:text="${p.title}">Título</label>
                                            <div class="text-secondary small mb-1">
                                                <i class="fa-solid fa-tags me-1"></i>
                                                <span th:text="${p.category}">Categoría</span>
                                                (<span th:text="${p.state}">Estado</span>)
                                            </div>
                                            <div class="text-muted small" th:text="${p.description}">Descripción</div>
                                        </div>
                                        <div style="width: 100px; height: 100px;">
                                            <img th:if="${p.photo != null and !#strings.isEmpty(p.photo)}"
                                                 th:src="@{/product-images/{file}(file=${p.photo})}"
                                                 alt="Foto del producto"
                                                 class="img-fluid rounded"
                                                 style="object-fit: cover; width: 100%; height: 100%;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="col-md-2 d-flex flex-column justify-content-center align-items-center gap-2">
                            <!-- Solo mostrar botones si no ha confirmado aún -->
                            <div th:if="${!yoConfirme}" class="w-100">
                                <form th:action="@{/offers/deliveries/confirm}" method="post" th:id="'confirmForm' + ${iter.index}">
                                    <input type="hidden" name="offerId" th:value="${offer.idOffer}" />
                                    <input type="hidden" name="wasDelivered" value="true" />

                                    <!-- Calificación con estrellas -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold text-center d-block small">
                                            Califica tu experiencia:
                                        </label>
                                        <div class="rating-stars text-center">
                                            <input type="radio" name="rating" value="5" id="star5" th:id="'star5_' + ${iter.index}" required>
                                            <label th:for="'star5_' + ${iter.index}" title="5 estrellas">★</label>

                                            <input type="radio" name="rating" value="4" id="star4" th:id="'star4_' + ${iter.index}" required>
                                            <label th:for="'star4_' + ${iter.index}" title="4 estrellas">★</label>

                                            <input type="radio" name="rating" value="3" id="star3" th:id="'star3_' + ${iter.index}" required>
                                            <label th:for="'star3_' + ${iter.index}" title="3 estrellas">★</label>

                                            <input type="radio" name="rating" value="2" id="star2" th:id="'star2_' + ${iter.index}" required>
                                            <label th:for="'star2_' + ${iter.index}" title="2 estrellas">★</label>

                                            <input type="radio" name="rating" value="1" id="star1" th:id="'star1_' + ${iter.index}" required>
                                            <label th:for="'star1_' + ${iter.index}" title="1 estrella">★</label>
                                        </div>
                                    </div>

                                    <button type="submit" class="btn btn-outline-success w-100 mb-2">
                                        <i class="fa-solid fa-check me-2"></i> Confirmar entrega
                                    </button>
                                </form>

                                <button type="button" class="btn btn-outline-danger w-100"
                                        data-bs-toggle="modal"
                                        th:attr="data-bs-target=${'#cancelModal' + iter.index}">
                                    <i class="fa-solid fa-times me-2"></i> Cancelar entrega
                                </button>
                            </div>

                            <!-- Mensaje si ya confirmó -->
                            <div th:if="${yoConfirme}" class="text-center">
                                <span class="badge bg-success fs-6">
                                    <i class="fa-solid fa-check-circle me-1"></i>
                                    Ya confirmaste
                                </span>
                            </div>
                        </div>
                    </div> <!-- /.row -->
                </div> <!-- /.card-body -->
            </div> <!-- /.card -->

            <!-- Modal de cancelación -->
            <div class="modal fade" th:id="${'cancelModal' + iter.index}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">
                                <i class="fa-solid fa-exclamation-triangle me-2"></i>
                                Cancelar Entrega
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <p class="mb-2">¿Estás seguro de que deseas <strong>cancelar esta entrega</strong>?</p>
                            <p class="text-muted">Los productos se reactivarán y recibirás una penalización en tu reputación.</p>
                        </div>
                        <div class="modal-footer justify-content-center">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                <i class="fa-solid fa-times me-2"></i> No, mantener
                            </button>
                            <form th:action="@{/offers/deliveries/confirm}" method="post" class="d-inline">
                                <input type="hidden" name="offerId" th:value="${offer.idOffer}" />
                                <input type="hidden" name="wasDelivered" value="false" />
                                <button type="submit" class="btn btn-outline-danger">
                                    <i class="fa-solid fa-ban me-2"></i> Sí, cancelar
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- /.col -->
    </div> <!-- /.row -->
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Cierra automáticamente la alerta después de 2 segundos
    setTimeout(() => {
        const alert = document.querySelector('.alert-dismissible');
        if (alert) bootstrap.Alert.getOrCreateInstance(alert).close();
    }, 2000);
</script>
</body>
</html>
