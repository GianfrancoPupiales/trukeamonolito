<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Bandeja de Ofertas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>

<body>
<!-- Navbar -->
<th:block th:replace="~{navbar :: navbar}"></th:block>

<main class="container my-4">
    <h1 class="mb-0 text-center">Ofertas Recibidas</h1>

    <!-- Feedback -->
    <th:block th:replace="~{alert :: alert}"></th:block>

    <!-- Si no hay ofertas -->
    <div th:if="${receivedOffers == null or #lists.isEmpty(receivedOffers)}" class="alert alert-info text-center">
        No tienes ofertas pendientes por revisar.
    </div>

    <!-- Si hay ofertas -->
    <div class="row row-cols-1 g-4" th:if="${receivedOffers != null and !#lists.isEmpty(receivedOffers)}">
        <div class="col" th:each="offer : ${receivedOffers}">
            <div class="card shadow-sm border-0 rounded-3">
                <div class="card-body">
                    <h5 class="fw-bold text-dark mb-3">
                        <i class="fa-solid fa-handshake me-2"></i>
                        Propuesta de Intercambio de:
                        <a class="text-decoration-none"
                           th:href="@{/profile/public/{id}(id=${offer.studentWhoOffered.idStudent})}">
                            <span th:text="${offer.studentWhoOffered.name}">Nombre</span>
                        </a>
                    </h5>

                    <div class="row">
                        <!-- Columna 1: Productos ofrecidos -->
                        <div class="col-md-5">
                            <h6 class="fw-bold text-secondary mb-3">Productos ofrecidos</h6>
                            <div th:each="prod : ${offer.offeredProducts}" class="card border-1 rounded-3 mb-3 px-3 py-2">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-start" style="flex: 1;">
                                        <div>
                                            <label class="fw-bold mb-1" th:text="${prod.title}">Producto</label>
                                            <div class="text-secondary small mb-1">
                                                <i class="fa-solid fa-tags me-1"></i>
                                                <span th:text="${prod.category}">Categoría</span>
                                                (<span th:text="${prod.state}">Estado</span>)
                                            </div>
                                            <div class="text-muted small" th:text="${prod.description}">Descripción</div>
                                        </div>
                                    </div>
                                    <div style="width: 100px; height: 100px;">
                                        <img th:if="${prod.photo != null and !#strings.isEmpty(prod.photo)}"
                                             th:src="@{/product-images/{file}(file=${prod.photo})}"
                                             alt="Foto del producto"
                                             class="img-fluid rounded"
                                             style="object-fit: cover; width: 100%; height: 100%;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Columna 2: Producto solicitado -->
                        <div class="col-md-5">
                            <h6 class="fw-bold text-secondary mb-3">Producto solicitado</h6>
                            <div class="card border-1 rounded-3 px-3 py-2">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <label class="fw-bold mb-1" th:text="${offer.productToOffer.title}">Título</label>
                                        <div class="text-secondary small mb-1">
                                            <i class="fa-solid fa-tags me-1"></i>
                                            <span th:text="${offer.productToOffer.category}">Categoría</span>
                                            (<span th:text="${offer.productToOffer.state}">Estado</span>)
                                        </div>
                                        <div class="text-muted small" th:text="${offer.productToOffer.description}">Descripción</div>
                                    </div>
                                    <div style="width: 100px; height: 100px;">
                                        <img th:if="${offer.productToOffer.photo != null and !#strings.isEmpty(offer.productToOffer.photo)}"
                                             th:src="@{/product-images/{file}(file=${offer.productToOffer.photo})}"
                                             alt="Foto del producto"
                                             class="img-fluid rounded"
                                             style="object-fit: cover; width: 100%; height: 100%;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Columna 3: Botones -->
                        <div class="col-md-2 d-flex flex-column justify-content-center align-items-center">
                            <form th:action="@{/offers/respond}" method="post">
                                <input type="hidden" name="offerId" th:value="${offer.idOffer}" />
                                <div class="d-grid gap-2">
                                    <button type="submit" name="action" value="accept"
                                            class="btn btn-outline-success px-4 py-2 w-100">
                                        <i class="fa-solid fa-circle-check me-2"></i> Aceptar
                                    </button>
                                    <button type="submit" name="action" value="reject"
                                            class="btn btn-outline-danger px-4 py-2 w-100">
                                        <i class="fa-solid fa-ban me-2"></i> Rechazar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div> <!-- /.row -->
                </div> <!-- /.card-body -->
            </div> <!-- /.card -->
        </div> <!-- /.col -->
    </div> <!-- /.row -->
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Cierra automáticamente la alerta después de 2 segundos
    setTimeout(() => {
        const alert = document.querySelector('.alert-dismissible');
        if (alert) {
            const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
            bsAlert.close();
        }
    }, 2000);
</script>
</body>
</html>
