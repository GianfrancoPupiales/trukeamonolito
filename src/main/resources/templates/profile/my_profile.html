<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Perfil</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap & Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body class="bg-white">
<!-- Navbar -->
<th:block th:replace="~{navbar :: navbar}"></th:block>

<main class="container my-4">
    <!-- Alertas -->
    <th:block th:replace="~{alert :: alert}"></th:block>

    <div class="row justify-content-center">
        <div class="row">
            <!-- Columna izquierda -->
            <div class="col-md-6">
                <div class="card border-0 rounded-3 mb-4 h-100">
                    <div class="card-body p-4">
                        <h4 class="text-dark fw-bold mb-3">Información personal</h4>
                        <hr class="my-4">

                        <!-- Imagen de perfil -->
                        <div class="w-100 d-flex justify-content-center mb-4">
                            <img th:if="${profile != null and profile.photo != null and !#strings.isEmpty(profile.photo)}"
                                 th:src="@{/student-images/{file}(file=${profile.photo})}"
                                 alt="Foto de perfil"
                                 class="img-fluid rounded-circle"
                                 style="max-width: 150px; height: 150px; object-fit: cover;">

                            <img th:if="${profile == null or profile.photo == null or #strings.isEmpty(profile.photo)}"
                                 th:src="@{/assets/default-user.png}"
                                 alt="Foto por defecto"
                                 class="img-fluid rounded-circle"
                                 style="max-width: 150px; height: 150px; object-fit: cover;">
                        </div>

                        <p class="card-text text-secondary small mb-3">
                            <i class="fa-solid fa-user me-2"></i>
                            <strong>Nombre:</strong>
                            <span th:text="${profile.name}">Nombre</span>
                        </p>

                        <p class="card-text text-secondary small mb-3">
                            <i class="fa-solid fa-envelope me-2"></i>
                            <strong>Correo:</strong>
                            <span th:text="${profile.email}">correo@epn.edu.ec</span>
                        </p>

                        <p class="card-text text-secondary small mb-3">
                            <i class="fa-solid fa-phone me-2"></i>
                            <strong>Teléfono:</strong>
                            <span th:text="${profile.phone}">0999999999</span>
                        </p>

                        <p class="card-text text-secondary small mb-3">
                            <i class="fa-solid fa-id-card me-2"></i>
                            <strong>Código único:</strong>
                            <span th:text="${profile.uniqueCode}">000000000</span>
                        </p>

                        <!-- Botón para abrir modal -->
                        <div class="d-grid">
                            <button class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                                <i class="fa-solid fa-pen-to-square me-2"></i> Editar información
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna derecha -->
            <div class="col-md-6">
                <div class="card border-0 rounded-3 mb-4 h-100">
                    <div class="card-body p-4">
                        <h4 class="text-dark fw-bold mb-3">Reputación</h4>
                        <hr class="my-4">

                        <div th:if="${profile != null and profile.reputation != null and profile.reputation.totalVotes > 0}">
                            <p class="card-text text-secondary small mb-3">
                                <i class="fa-solid fa-star me-2 text-warning"></i>
                                <strong>Calificación promedio:</strong>
                                <span th:text="${#numbers.formatDecimal(profile.reputation.averageScore, 1, 2)}">4.5</span>
                                (<span th:text="${profile.reputation.totalVotes}">0</span> votos)
                            </p>

                            <div class="progress mb-3" style="height: 20px;">
                                <div class="progress-bar bg-warning"
                                     role="progressbar"
                                     th:style="'width:' + (${profile.reputation.averageScore} * 20) + '%'"
                                     th:aria-valuenow="${profile.reputation.averageScore * 20}"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                    <span th:text="${#numbers.formatDecimal(profile.reputation.averageScore, 1, 1)}">4.5</span>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info d-flex align-items-center small"
                             th:if="${profile == null or profile.reputation == null or profile.reputation.totalVotes == 0}"
                             role="alert">
                            <i class="fa-solid fa-circle-info me-2"></i>
                            Aún no tienes reputación registrada.
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- /.row -->
    </div>
</main>

<!-- Modal de edición de perfil -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form class="modal-content"
              th:action="@{/profile}"
              method="post"
              enctype="multipart/form-data"
              onsubmit="return validarEdicionPerfil()">

            <div class="modal-header">
                <h5 class="modal-title" id="editProfileModalLabel">Editar perfil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <div id="mensajeErrorPerfil" class="alert alert-danger d-none" role="alert"></div>

                <!-- Mantener la foto actual si no se sube una nueva -->
                <input type="hidden" name="existingPhoto" th:value="${profile.photo}"/>

                <div class="mb-3 text-center">
                    <img th:if="${profile != null and profile.photo != null and !#strings.isEmpty(profile.photo)}"
                         th:src="@{/student-images/{file}(file=${profile.photo})}"
                         alt="Foto actual"
                         class="img-fluid rounded-circle"
                         style="max-width: 120px; height: 120px; object-fit: cover;">
                    <img th:if="${profile == null or profile.photo == null or #strings.isEmpty(profile.photo)}"
                         th:src="@{/assets/default-user.png}"
                         alt="Foto por defecto"
                         class="img-fluid rounded-circle"
                         style="max-width: 120px; height: 120px; object-fit: cover;">
                </div>

                <div class="mb-3">
                    <label class="form-label">Cambiar foto</label>
                    <input type="file" class="form-control" name="newPhoto" accept="image/*">
                </div>

                <div class="mb-3">
                    <label class="form-label">Nombre</label>
                    <input type="text" class="form-control" name="name" id="editName" th:value="${profile.name}" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Correo</label>
                    <input type="email" class="form-control" name="email" id="editEmail" th:value="${profile.email}" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Teléfono</label>
                    <input type="text" class="form-control" name="phone" id="editPhone"
                           th:value="${profile.phone}"
                           pattern="^\d{10}$" maxlength="10"
                           title="Número de teléfono válido (10 dígitos)">
                </div>

                <div class="mb-1">
                    <label class="form-label">Contraseña (dejar vacío si no desea cambiarla)</label>
                    <input type="password" class="form-control" name="password" id="editPassword">
                </div>
            </div>

            <div class="modal-footer border-0">
                <div class="d-flex w-100 gap-2">
                    <button type="button" class="btn btn-outline-danger fw-bold w-50" data-bs-dismiss="modal">
                        <i class="fa-solid fa-xmark me-2"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-outline-success fw-bold w-50">
                        <i class="fa-solid fa-floppy-disk me-2"></i> Guardar cambios
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Cierra automáticamente la alerta después de 2 segundos
    setTimeout(() => {
        const alert = document.querySelector('.alert-dismissible');
        if (alert) {
            const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
            bsAlert.close();
        }
    }, 2000);

    function mostrarErrorPerfil(mensaje) {
        const contenedor = document.getElementById("mensajeErrorPerfil");
        contenedor.textContent = mensaje;
        contenedor.classList.remove("d-none");
        contenedor.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function ocultarErroresPerfil() {
        const contenedor = document.getElementById("mensajeErrorPerfil");
        if (contenedor) contenedor.classList.add("d-none");
    }

    function validarEdicionPerfil() {
        ocultarErroresPerfil();

        const email = document.getElementById("editEmail").value.trim();
        const phone = document.getElementById("editPhone").value.trim();
        const password = document.getElementById("editPassword").value;

        const emailRegex = /^[a-zA-Z]+(\.[a-zA-Z]+[0-9]*)?@epn\.edu\.ec$/;
        if (!emailRegex.test(email)) {
            mostrarErrorPerfil("Por favor, ingrese un correo institucional válido (ej: nombre.apellido@epn.edu.ec).");
            return false;
        }

        const phoneRegex = /^\d{10}$/;
        if (phone && !phoneRegex.test(phone)) {
            mostrarErrorPerfil("El número de teléfono debe tener 10 dígitos numéricos.");
            return false;
        }

        if (password) {
            const passRegex = /^(?=.*[A-Z])(?=.*\d)(?=.*[@$!_#%*?&])[A-Za-z\d@$!_#%*?&]{8,}$/;
            if (!passRegex.test(password)) {
                mostrarErrorPerfil("La contraseña debe tener al menos 8 caracteres, una mayúscula, un número y un carácter especial.");
                return false;
            }
        }
        return true;
    }
</script>
</body>
</html>